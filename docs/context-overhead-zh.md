# 上下文开销分析

> Trellis 占用多少上下文？详细拆解。

---

## 快速回答

| 场景 | Tokens | 1M 窗口 | 200k 窗口 |
|------|--------|---------|-----------|
| **Session 启动** | ~6,500 | 0.65% | 3.25% |
| **峰值 (Implement 运行时)** | ~11,000 | 1.1% | 5.5% |
| **完整工作流程** | ~8,500 平均 | 0.85% | 4.25% |

**结论**：Trellis 峰值占用 **1M 的 ~1%** 或 **200k 的 ~5%**，剩余空间全部可用。

---

## Trellis 上下文机制

### 核心理解：Subagent 上下文是独立的

每个 Subagent 运行时有**独立隔离的上下文**，结束后被丢弃：

```
Main Agent (持久)            Subagent (临时)
─────────────────────────   ─────────────────────
│ ~6,500 tokens          │  │ ~4,100 tokens    │
│ ├─ workflow.md         │  │ ├─ agent prompt  │
│ ├─ index 文件          │  │ ├─ jsonl 规范    │
│ └─ start 命令          │──│ └─ prd.md        │
│                        │  └─────────────────────
│ + subagent 输出结果    │       (结束后丢弃)
└─────────────────────────
```

只有 Subagent 的**输出结果**会累积到 Main Agent 的对话历史中。

---

## 各 Agent 上下文详解

### Main Agent (人机交互)

通过 `SessionStart` Hook 在会话启动时注入：

| 组件 | Tokens | 1M | 200k |
|------|--------|-----|------|
| workflow.md | ~2,871 | 0.29% | 1.44% |
| start.md (命令) | ~1,638 | 0.16% | 0.82% |
| get-context.sh 输出 | ~748 | 0.07% | 0.37% |
| frontend/index.md | ~335 | 0.03% | 0.17% |
| backend/index.md | ~352 | 0.04% | 0.18% |
| guides/index.md | ~586 | 0.06% | 0.29% |
| **合计** | **~6,530** | **0.65%** | **3.27%** |

### Research Agent

用于代码库探索的轻量级 Agent：

| 组件 | Tokens | 1M | 200k |
|------|--------|-----|------|
| research.md (agent prompt) | ~617 | 0.06% | 0.31% |
| 项目结构模板 | ~100 | 0.01% | 0.05% |
| Prompt wrapper | ~225 | 0.02% | 0.11% |
| research.jsonl (可选) | 0-500 | 0-0.05% | 0-0.25% |
| **合计** | **~942-1,442** | **0.09-0.14%** | **0.47-0.72%** |

### Implement Agent

最重的 Agent，携带开发规范：

| 组件 | Tokens | 1M | 200k |
|------|--------|-----|------|
| implement.md (agent prompt) | ~513 | 0.05% | 0.26% |
| Prompt wrapper | ~112 | 0.01% | 0.06% |
| implement.jsonl 内容 | ~3,000-3,500 | 0.30-0.35% | 1.50-1.75% |
| prd.md | ~300 | 0.03% | 0.15% |
| info.md (可选) | 0-500 | 0-0.05% | 0-0.25% |
| **合计** | **~3,925-4,925** | **0.39-0.49%** | **1.96-2.46%** |

### Check Agent

代码质量验证：

| 组件 | Tokens | 1M | 200k |
|------|--------|-----|------|
| check.md (agent prompt) | ~708 | 0.07% | 0.35% |
| Prompt wrapper | ~120 | 0.01% | 0.06% |
| check.jsonl 内容 | ~970-1,500 | 0.10-0.15% | 0.49-0.75% |
| prd.md | ~300 | 0.03% | 0.15% |
| **合计** | **~2,098-2,628** | **0.21-0.26%** | **1.05-1.31%** |

### Debug Agent

问题修复专家：

| 组件 | Tokens | 1M | 200k |
|------|--------|-----|------|
| debug.md (agent prompt) | ~483 | 0.05% | 0.24% |
| Prompt wrapper | ~130 | 0.01% | 0.07% |
| debug.jsonl 内容 | ~970-1,500 | 0.10-0.15% | 0.49-0.75% |
| codex-review-output.txt | 0-2,000 | 0-0.20% | 0-1.00% |
| **合计** | **~1,583-4,113** | **0.16-0.41%** | **0.79-2.06%** |

### Finish Agent

轻量级最终验证 (Check agent 带 `[finish]` 标记)：

| 组件 | Tokens | 1M | 200k |
|------|--------|-----|------|
| check.md (agent prompt) | ~708 | 0.07% | 0.35% |
| Prompt wrapper | ~125 | 0.01% | 0.06% |
| finish-work.md | ~791 | 0.08% | 0.40% |
| prd.md | ~300 | 0.03% | 0.15% |
| **合计** | **~1,924** | **0.19%** | **0.96%** |

---

## 工作流程时间线

典型开发周期中的上下文使用：

| 阶段 | Main Agent | Subagent | 峰值合计 | 1M | 200k |
|------|------------|----------|----------|-----|------|
| Session 启动 | 6,530 | - | 6,530 | 0.65% | 3.27% |
| + Research | 6,530 | 1,000 | 7,530 | 0.75% | 3.77% |
| + Research 输出 | 7,030 | - | 7,030 | 0.70% | 3.52% |
| + Implement | 7,030 | 4,100 | **11,130** | **1.11%** | **5.57%** |
| + Implement 输出 | 7,830 | - | 7,830 | 0.78% | 3.92% |
| + Check | 7,830 | 2,300 | 10,130 | 1.01% | 5.07% |
| + Check 输出 | 8,430 | - | 8,430 | 0.84% | 4.22% |

**峰值使用：~11,130 tokens** (Implement 阶段)

---

## Agent 对比汇总

| Agent | Tokens | 1M | 200k | 用途 |
|-------|--------|-----|------|------|
| Research | ~1,000 | 0.10% | 0.50% | 代码库探索 |
| Finish | ~1,900 | 0.19% | 0.95% | PR 前最终检查 |
| Check | ~2,300 | 0.23% | 1.15% | 质量验证 |
| Debug | ~2,200 | 0.22% | 1.10% | 问题修复 |
| Implement | ~4,100 | 0.41% | 2.05% | 功能开发 |

---

## 优化建议

### 1. 精心配置 JSONL 文件

只包含直接相关的规范：

```jsonl
// 好：只包含任务相关的规范
{"file": ".trellis/spec/frontend/components.md"}

// 避免：workflow.md 已经在 Main Agent 中
{"file": ".trellis/workflow.md"}  // 冗余
```

### 2. 尽量使用轻量级 Agent

- 快速探索 → **Research** (~1,000 tokens)
- 最终验证 → **Finish** (~1,900 tokens)
- 完整质量检查 → **Check** (~2,300 tokens)

### 3. 跳过不必要的阶段

如果你明确知道要做什么：
- 跳过 Research，直接进入 Implement
- 简单任务用 Finish 代替完整 Check

### 4. 监控 JSONL 文件大小

```bash
# 检查 jsonl 文件引用了什么
cat .trellis/tasks/your-task/implement.jsonl

# 测量总上下文
for f in $(jq -r '.file' implement.jsonl); do
  wc -c "$f"
done
```

---

## 常见问题

### Q: 上下文会在多次 Subagent 调用间累积吗？

**不会。** 每个 Subagent 有独立上下文。只有它们的输出会累积到 Main Agent。

### Q: 最小上下文占用是多少？

**~6,530 tokens** (Session 启动时)。这是使用 Trellis 的基线开销。

### Q: 32k 上下文的模型能用 Trellis 吗？

**可以但比较紧张。** 峰值 (~11k) 占 32k 的 34%。你将有 ~21k 用于实际工作。建议禁用 MCP 服务器并使用最小化的 JSONL 文件。

### Q: MCP 对此有什么影响？

**MCP 是独立计算的。** 每个 MCP 工具定义增加 ~100-300 tokens。一个有 10 个工具的服务器增加 ~1,000-3,000 tokens。禁用不用的服务器可以节省上下文。

---

## 总结

| 模型 | Trellis 开销 | 剩余可用 |
|------|-------------|---------|
| **1M tokens** | ~1.1% 峰值 | **~988,870 tokens** |
| **200k tokens** | ~5.6% 峰值 | **~188,870 tokens** |
| **128k tokens** | ~8.7% 峰值 | **~116,870 tokens** |
| **32k tokens** | ~34.8% 峰值 | **~20,870 tokens** |

Trellis 为现代大上下文模型设计。使用 200k+ 上下文时，框架开销可忽略不计。
